version: 2
jobs:
  build:
    docker:
      - image: circleci/node:10.13.0-stretch-browsers
    working_directory: ~/repo
    steps:
      - checkout
      - restore_cache:
          keys:
          - v1-dependencies-{{ checksum "package.json" }}
          - v1-dependencies-
      - run: yarn install
      - save_cache:
          paths:
            - node_modules
          key: v1-dependencies-{{ checksum "package.json" }}
      - run: yarn build
      - run: yarn export
      # make the `/out` directory available to the deploy job
      - persist_to_workspace:
            root: ~/repo
            paths:
              - out

  deploy:
    docker:
      - image: circleci/python:2.7-jessie
    working_directory: ~/repo
    steps:
      # make the `/out` directory accessible
      - attach_workspace:
          at: .
      - run:
          name: Install awscli
          command: sudo pip install awscli
      - run:
          name: Deploy to S3
          command: aws s3 sync out s3://apjbass.com/ --delete

  deploy preview:
    docker:
      - image: circleci/python:2.7-jessie
    working_directory: ~/repo
    steps:
      - attach_workspace:
          at: .
      - run:
          name: Install awscli
          command: sudo pip install awscli
      - run:
          name: Deploy preview to S3
          command: aws s3 sync out s3://preview.apjbass.com/build/${CIRCLE_SHA1}/ --acl public-read
      - run:
          name: Notify in GH PR
          command: |
            curl -XPOST \
              -H "Authorization: token ${GH_TOKEN}" \
              -H "Content-type: application/json" -d '{ \
                "state": "success",\
                "target_url": "//preview.apjbass.com/build/${CIRCLE_SHA1}/",\
                "description": "Preview available",\
                "context": "ci/circleci: preview"\
              }' 'https://api.github.com/repos/alexbassy/${CIRCLE_PROJECT_REPONAME}/statuses/${CIRCLE_SHA1}'

workflows:
  version: 2
  build-deploy:
    jobs:
      - build
      - deploy:
          requires:
            - build
          filters:
            branches:
              only: master
      - deploy preview:
          requires:
            - build
          filters:
            branches:
              ignore: master